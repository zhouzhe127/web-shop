(window.webpackJsonp=window.webpackJsonp||[]).push([["entity_card_ws"],{b52e:function(e,t,n){"use strict";n.r(t);var r=n("81a2"),s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function a(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){return function r(s,a){try{var i=t[s](a),o=i.value}catch(e){return void n(e)}if(!i.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}("next")})}}var i=function(){function e(t,n,r,s){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=n,"openCard"==t?(this.openCard=!0,this.nextStep=function(){r&&r(this.oid,this.token)}):"readcard"==t&&(this.openCard=!1,this.nextStep=function(){r&&r(this.oid,this.token)}),this.url="ws://localhost:9002",this.ws=null,this.errorHandle=s,this.openable=!1}return s(e,[{key:"start",value:function(){this.ws&&3!=this.ws.readyState?this.init():this.connect()}},{key:"init",value:function(){this.nfc=0,this.errorCard=!1,this.send("deskey:SDMEMBER"),this.openCard?this.send("opencard"):this.send("readcard")}},{key:"getOidAndToken",value:function(){var e=a(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,r.a.entitycardOpenCard({data:{memberCardId:"",cardKey:"",subShopId:""}});case 3:n=e.sent,/^\d{1,10}$/.test(n.memberCardId)&&/^[A-Za-z0-9]{13}$/.test(n.cardKey)&&t.send("data:"+n.memberCardId+":"+n.cardKey);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"checkOidAndToken",value:function(){var e=a(regeneratorRuntime.mark(function e(t,n){var s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=this,!0!==this.openable){e.next=6;break}this.openable=!1,this.cardInfoInput(t,n),e.next=10;break;case 6:return e.next=8,r.a.entitycardOpenCard({data:{memberCardId:t,cardKey:n,subShopId:""}});case 8:e.sent+""=="true"&&s.cardInfoInput(t,n);case 10:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"cardInfoInput",value:function(){var e=a(regeneratorRuntime.mark(function e(t,n){var s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return s=this,e.next=3,r.a.openCardInfoInput({data:{memberCardId:t,cardKey:n}});case 3:e.sent+""=="true"&&(s.send("initcard"),s.oid=t,s.token=n);case 5:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"getCardAccountMsg",value:function(e,t){this.oid=e,this.token=t,this.nextStep&&this.nextStep()}},{key:"getCardKey",value:function(){var e=a(regeneratorRuntime.mark(function e(){var t,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this,e.next=3,r.a.getCardPassword({data:{nfcNumber:this.nfc}});case 3:(n=e.sent)&&t.send("key:"+n);case 5:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"messageHandle",value:function(e){var t=e.split(":");switch(t[0]){case"openable":this.openable=!0,this.getOidAndToken();break;case"data":this.openCard?this.checkOidAndToken(t[1],t[2]):this.getCardAccountMsg(t[1],t[2]);break;case"opended":this.nextStep&&this.nextStep();break;case"card":this.nfc=t[1],this.getCardKey();break;case"error":if(this.errorHandle){var n="读取卡片信息失败,请确定该卡可用";this.openCard||(n="读取卡片信息失败,请确定该卡可使用并已激活"),this.errorHandle({message:n})}}}},{key:"connect",value:function(){if("WebSocket"in window)this.ws=new WebSocket(this.url);else{if(!("MozWebSocket"in window))return;this.ws=new MozWebSocket(this.url)}var e=this;this.ws.onopen=function(t){e.init(),console.log("开启")},this.ws.onerror=function(e){console.log(e),console.log("报错")},this.ws.onclose=function(e){console.log("读卡连接已经关闭")},this.ws.onmessage=function(t){e.messageHandle(t.data),console.log("已连接")}}},{key:"send",value:function(e){this.ws&&this.ws.send(e)}},{key:"disconnect",value:function(){this.ws&&(this.ws.close(),this.ws=null,this.oid=0,this.token=0)}}]),e}();t.default=i}}]);